# ğŸ”™â€‹[Laya](/docs/laya/)


## æ–‡å­—æµ‹é‡
æ·˜å®æŠ€æœ¯åé¦ˆ å†…å­˜å¢é•¿çš„åŸå› æ˜¯ctx.measureTextäº§ç”Ÿçš„å†…éƒ¨ä¸´æ—¶å¯¹è±¡ æ²¡åŠæ—¶gc
ä¼°è®¡å†…å­˜æ³„æ¼äº† åŒæ—¶æ¸¸æˆä¸­è°ƒç”¨çš„æ–¹å¼ä¹Ÿæœ‰é—®é¢˜ ä¸»ç•Œé¢æ¯å¸§éƒ½ä¼šé‡å¤è°ƒç”¨
å»ºè®®é‡‡ç”¨ç¼“å­˜æ–¹å¼ é¿å…æ— æ„ä¹‰çš„é‡å¤è®¡ç®—


## åŸå§‹å¼•æ“è°ƒç”¨åˆ†æ
æœç´¢æ‰€æœ‰è°ƒç”¨measureTextçš„åœ°æ–¹

1. Laya.ts
```
  åŸç”Ÿè®¡ç®—å­—ä½“å¤§å°
  static enableNative(): void {
  	Browser.measureText = function (txt: string, font: string): any {
        window["conchTextCanvas"].font = font;
        return window["conchTextCanvas"].measureText(txt);
    }
```
Browser.ts
```
  Browser.canvas = new HTMLCanvas(true);  // åˆ›å»ºç¦»å±ç”»å¸ƒ
  Browser.context = <CanvasRenderingContext2D>(Browser.canvas.getContext('2d') as any);
```

2. Text.ts
- å°†å•è¡Œå­—ç¬¦ä¸²åˆ‡å‰²ä¸ºå¤šè¡Œ
```
  h5çš„å­—ä½“è§„åˆ™ "bold size:12px simhei"
  å…ˆä»ç¼“å­˜ä¸­è·å– è‹¥æ²¡æœ‰ åˆ†åˆ«è°ƒç”¨nativeå’Œbrowserçš„contextæ¥è®¡ç®—æ–‡å­—å¤§å°
  ä½¿ç”¨æµ‹è¯•çš„å•ä¸ªå­—ä½“+æ˜¾ç¤ºå®½åº¦  æ¥ä¼°ç®—ä¸€è¡Œå­—æ•°
  å†ç»†åŒ–æ ¹æ®è‹±æ–‡å•è¯è¿˜æ˜¯ä¸­æ–‡ æ¥åˆ‡å‰²è¡Œ
  Text._testWord: string = "æ¸¸";

  _parseLines(text: string)
  	let cfont = ILaya.Browser.context.font || this._getContextFont(); //å¿«æ‰‹å¹³å°è·å–åˆ°ç©ºå­—ç¬¦ä¸²
    let font = cfont["font_size"] ?cfont["font_size"] + cfont["font_family"]:cfont;  //qqå¹³å°å¾—åˆ°ä¸€ä¸ªå¯¹è±¡ è€Œéå­—ç¬¦ä¸²
    var measureResult: any = Text._measureTemp[font];
    if(!measureResult) {
        if (ILaya.Render.isConchApp) {
            measureResult = (window as any).conchTextCanvas.measureText(Text._testWord);
        } else {
            measureResult = ILaya.Browser.context.measureText(Text._testWord);
        }
        if (!measureResult) measureResult = { width: 100 };

        Text._measureTemp[font] = measureResult;
    }
```
- å–æŸè¡Œå­—ç¬¦ä¸²å®½åº¦
```
  è‹¥æ˜¯å›¾ç‰‡å­—ä½“ åˆ™èµ°bitmapfontå†…éƒ¨çš„è®¡ç®—
  å¦åˆ™æ ¹æ®nativeå’Œh5 èµ°contextçš„measureText
  _getTextWidth(text: string)
    var bitmapFont: BitmapFont = ((<TextStyle>this._style)).currBitmapFont;
    if (bitmapFont) return bitmapFont.getTextWidth(text);
    else {
        if (ILaya.Render.isConchApp) {
            return (window as any).conchTextCanvas.measureText(text).width;;
        }
        else {
            let ret = ILaya.Browser.context.measureText(text) || { width: 100 };
            return ret.width;
        }
    }
  è°ƒç”¨çš„æ—¶æœº åˆ†ææŸä¸€è¡Œæ—¶_parseLineä½¿ç”¨ 
```
å­—ä½“è‡ªåŠ¨ç¼©æ”¾
```
  æ ¹æ®è¡Œå®½åº¦å’Œæ˜¾ç¤ºå®½åº¦ è®¡ç®—è‡ªåŠ¨ç¼©æ”¾å€¼ 
  è‹¥å¤šè¡Œ è®¡ç®—æ˜¾ç¤ºé«˜åº¦å®¹ä¸‹æ‰€æœ‰è¡Œçš„ç¼©æ”¾å€¼ æœ‰æé™æ§åˆ¶
  æœ‰bugï¼šå­—ä½“é‡‡ç”¨browserä¸­çš„ä¸Šæ¬¡è®°å½• èƒ½å¦ä¿è¯ä¸€å®šæ˜¯æœ¬æ¬¡çš„ï¼Ÿ
	_updateCurZoom(lines: string[])
	  for (let line of lines) {
        let measureResult;
        if (ILaya.Render.isConchApp) {
            measureResult = window["conchTextCanvas"].measureText(line);
        } else {
            measureResult = ILaya.Browser.context.measureText(line);
        }
```


3. HTMLElement.ts
åˆ†æhtmlå…ƒç´ æ–‡å­—å¤§å°
```
  ç”±äºæŒ‰å•ä¸ªå­—å­˜å‚¨ä¿¡æ¯ æ‰€æœ‰å¤§å°ä¹Ÿæ˜¯æŒ‰å•ä¸ªè®¡ç®—
  _getWords(): HTMLChar[] {
    var txt: string = this._text.text;
    for (var i: number = 0, n: number = txt.length; i < n; i++) {
        size = ILaya.Browser.measureText(txt.charAt(i), fontStr);
        words[i] = HTMLChar.create().setData(txt.charAt(i), size.width, size.height || style.fontSize, style);
```

4. Layout.ts
å·²æ³¨é‡ŠåºŸå¼ƒäº†

5. TTFLoader.ts
ccsæ–¹å¼ ä¸‹è½½ttfå­—ä½“å ç”¨æµ‹è¯•çš„å­—æ¥éªŒè¯æ˜¯å¦ä¸‹è½½å®Œæ¯•
```
  _testString: string = "LayaTTFFont";
  
  ccsä¸‹è½½å­—ä½“ ä¼°è®¡æœ‰äº›ç¯å¢ƒonloadä¸ä¼šè°ƒç”¨ æ‰€ä»¥ç”¨äº†checkå‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦ä¸‹è½½å®Œ
  é€šè¿‡ä¸‹è½½å‰æµ‹é‡å­—ä½“å®½åº¦å’Œä¸‹è½½åå®½åº¦æ¯”è¾ƒ  ä¼šå¸¦ä¸Šå…·ä½“çš„å­—ä½“
  
  _loadWithCSS(): void {
    var fontStyle: any = Browser.createElement("style");
  	this._txtWidth = Browser.measureText(TTFLoader._testString, this._fontTxt).width;
  	fontStyle.onload = function (): void {
        ILaya.systemTimer.once(10000, self, self._complete);
    };
    ILaya.systemTimer.loop(20, this, this._checkComplete);
  		
  _checkComplete(): void {
    if (ILaya.Browser.measureText(TTFLoader._testString, this._fontTxt).width != this._txtWidth) {
        this._complete();
    }
```


6. Context.ts
æ²¡å®ç°  åè€Œè§‰å¾—å¯ä»¥æ‰©å±•è¿™é‡Œ å®ç°ä¸€ä¸ªå…¬å…±çš„ å¸¦ç¼“å­˜çš„è®¡ç®—
```
  measureText(text: string): any {
    return null;
}
```

7. Browser.ts
```
  æ£€æµ‹å‰ ä¸´æ—¶ä¿®æ”¹ctx.font = font;  å‘ç°ä¸ªbug æ²¡è¿˜åŸå›å»ï¼ï¼ï¼
  ä½†æ˜¯ä¸åŒç¯å¢ƒctx.fontè¿˜ä¸ä¸€å®šæ˜¯å­—ç¬¦ä¸² å¯èƒ½æ˜¯å¯¹è±¡ å¯èƒ½æ˜¯ç©º æ€ä¹ˆä¿å­˜ï¼Ÿsave/restoreï¼Ÿ
  æ³¨æ„ï¼šè¿™é‡Œçš„æ±‰å­— åªåŒ¹é…ä¸€ä¸ª æœ‰å‰åé™åˆ¶ç¬¦  
  æ‰€ä»¥è¿™ä¸ªå‡½æ•°å¹¶ä¸é€šç”¨ åªèƒ½ç”¨äºcssçš„å­—ä½“ä¸‹è½½æ£€æµ‹ï¼ï¼ï¼
  static hanzi: RegExp = new RegExp("^[\u4E00-\u9FA5]$");
  measureText: Function = function (txt: string, font: string)
     var isChinese: boolean = Browser.hanzi.test(txt);
        if (isChinese && Browser.fontMap[font]) {
            return Browser.fontMap[font];
    
    var ctx: any = Browser.context;
    ctx.font = font;

    var r: any = ctx.measureText(txt);
    if (isChinese) Browser.fontMap[font] = r;
```

8. CharRender_Canvas.ts
è®¡ç®—å­—ç¬¦ä¸²å®½åº¦ æä¾›ç»™TextRender æ¸²æŸ“æ—¶å¯¹å…¶æ–¹å¼éœ€è¦
```
  ç‹¬ç«‹çš„canvaså’Œcontext å’Œbrowserä¸æ˜¯åŒä¸€ä¸ª
  åæœŸå¯ä¿®æ”¹w h  
  ä¸»è¦ä¸ºäº†äº§ç”Ÿå­—ç¬¦ä¸²çº¹ç†ç”¨ é€šè¿‡ctx.getImageDataç»™å¼•æ“ä½¿ç”¨ å˜æˆä¸€å¼ textureçº¹ç†
  è€Œä¸”æ˜¯å­—ç¬¦ä¸²åˆå›¾ ä¼šè®¡ç®—ç©ºç™½åŒºåŸŸ ç”¨äºä¸‹æ¬¡æ¸²æŸ“çš„ä½ç½®
  constructor() {
  	CharRender_Canvas.canvas = Browser.createElement('canvas');
    CharRender_Canvas.canvas.width = 1024;
    CharRender_Canvas.canvas.height = 512;
    document.body.appendChild(CharRender_Canvas.canvas);;
	this.ctx = CharRender_Canvas.canvas.getContext('2d');
  }
  
  å…ˆåˆ‡æ¢ç¯å¢ƒå­—ä½“ ä¸Šé¢çš„browserçš„bug å¯å‚è€ƒè¿™é‡Œ
  getWidth(font: string, str: string): number {
    if (this.ctx._lastFont != font) {
        this.ctx.font = font;
        this.ctx._lastFont = font;
    }
    return this.ctx.measureText(str).width;
    
  å¾—åˆ°å•ä¸ªå­—ç¬¦çš„çº¹ç†
  ç”¨contextçš„apiç”»å­—ä½“ æ‹¿åˆ°çº¹ç†çš„ImageData
  åæœŸé€šè¿‡
  var tex: TextTexture = TextTexture.getTextTexture(imgdt.width, imgdt.height);  tex.addChar(imgdt, 0, 0, ri.uv);
  ä¼ ç»™Texture  å®é™…é€šè¿‡gl.texSubImage2D(gl.TEXTURE_2D, 0, x, y, data.width, data.height, gl.RGBA, gl.UNSIGNED_BYTE, data.data);
  ä¼ ç»™gpuçš„çº¹ç†
				
  getCharBmp(char: string, font: string, lineWidth: number, 
    if (!this.supportImageData)
		return this.getCharCanvas(
    cri.width = ctx.measureText(char).width;//æ’ç‰ˆç”¨çš„widthæ˜¯æ²¡æœ‰ç¼©æ”¾çš„ã€‚åé¢ä¼šç”¨çŸ©é˜µç¼©æ”¾
    ctx.strokeText(char
    ctx.fillText(char,
    imgdt: ImageData = rect ? (ctx.getImageData(rect[0],

  ç±»ä¼¼ä¸Šé¢ åªæ˜¯è¿”å›çš„æ˜¯canvasæœ¬èº« åæœŸä½¿ç”¨åŒä¸Š
  é’ˆå¯¹ä¸èƒ½ä½¿ç”¨getImageDataå‡½æ•°çš„ç¯å¢ƒï¼Ÿ  é»˜è®¤æ²¡èµ°è¿™
  getCharCanvas(char: string, font: string, lineWidth
    cri.width = ctx.measureText(char).width;
```

9. CharRender_Native.ts
å’Œcanvasç±»ä¼¼ åº•å±‚nativeå°è£…äº†ç±»ä¼¼åŠŸèƒ½çš„å‡½æ•°
```
  getWidth(font: string, str: string)
    return (window as any).conchTextCanvas.measureText(str).width;
    
  getCharBmp(char: string, font: string
    w: number = size.width = (window as any).conchTextCanvas.measureText(char).width;
```


## è¿è¡Œè°ƒç”¨åˆ†æ
æ‰€æœ‰è°ƒç”¨measureTextçš„åœ°æ–¹éƒ½åŠ log


1. ç™»å½•ç•Œé¢
```
    ç›¸åŒå‡ºç°è¿‡
    Text._getTextWidth: å…¬å…±1æœ 77 22 SimHei  ç›¸éš”å¤šæ¬¡
    CharRender_Canvas.getWidth å…¬å…±1æœ 77 undefined 22px SimHei è¿ç»­2æ¬¡

    å¤šä¸ªå‡½æ•°ç›¸åŒå†…å®¹
    Text._updateCurZoom2: ç¦»çº¿æˆ˜æ–— 80 undefined 128 0.625 1
    Text._getTextWidth: ç¦»çº¿æˆ˜æ–— 80 20 Arial
    CharRender_Canvas.getCharBmp ç«çˆ† 48 undefined 24px SimHei
```

2. è¿”å›çš„å¯¹è±¡æ˜¯ä¸ªå•¥
```
  æ³¨æ„ï¼šæ²¡æœ‰height è¿™é‡Œæ˜¯æµè§ˆå™¨é‡Œè¿è¡Œçš„ç»“æœ å®é™…å¼•æ“ä¸­åªç”¨åˆ°äº†width
    g 19.546875 undefined bold 32px Arial
    æœ‰ 32 undefined bold 32px Arial  æ­£æ–¹å½¢ï¼Ÿ
  
   ç¦»çº¿æˆ˜æ–— 80 undefined 20px Arial
	TextMetrics {
        actualBoundingBoxAscent: 17
        actualBoundingBoxDescent: 2
        actualBoundingBoxLeft: 0
        actualBoundingBoxRight: 80
        alphabeticBaseline: -0
        fontBoundingBoxAscent: 18
        fontBoundingBoxDescent: 4
        hangingBaseline: 14.399999618530273
        ideographicBaseline: -4
        width: 80
    }
```

3. ä¸»ç•Œé¢ä¸ºä½•ä¼šä¸€ç›´è°ƒç”¨measureText è€Œç™»å½•ç•Œé¢ä¸ä¼š
åŸå› ï¼šText.changeText(str)
```
  å¦‚æœç¬¬ä¸€æ¬¡ä½¿ç”¨ æˆ–é€šè¿‡text=â€œâ€çš„æ–¹å¼åˆ›å»º ä¼šå¾—åˆ°ä¸€ä¸ªwordtext
  typeset() {
    this._renderText();
    
  _renderText() {
    _word = new WordText();
     _word.setText(word);
      _word.splitRender = this._singleCharRender;
      graphics.fillBorderText(_word, x, y, ctxFont
  
  å¦‚æœè¢«changetextäº† åˆ™ä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸² å¯¼è‡´åç»­çš„æ¸²æŸ“æµç¨‹æ”¹äº†
  changeText(text: string)
	if (this._graphics && this._graphics.replaceText(this._text)) {
	
  å¦‚æœä¹‹å‰å·²ç»æœ‰cmd ç›´æ¥æ›¿æ¢å†…éƒ¨çš„å­—ç¬¦ä¸²
  replaceText(text: string)
    var cmds: any[] = this._cmds;
        if (!cmds) {
            if (this._one && this._isTextCmd(this._one)) {
                this._one.text = text;

  FillTextCmd.ts
	set text(value: string | WordText) {
        this._text = value;
        this._textIsWorldText = value instanceof WordText;

  æ„é€ æ—¶å¯èƒ½å°±æ˜¯words
  static create(text: string | WordText, words: HTMLChar[]
    cmd.text = text;
    cmd._textIsWorldText = text instanceof WordText;
    cmd._words = words;
  
  è‹¥è¢«setä¸ºå­—ç¬¦ä¸² åˆ™ç›´æ¥ç”¨_textæ¸²æŸ“ 
  run(context: Context, gx: number, gy: number): void {
    if (this._words) {
        Context._textRender.fillWords(context, this._words, 
    } else {
        if (this._textIsWorldText) {// å¿«é€Ÿé€šé“
            context._fast_filltext(((<WordText>this._text)), this.x 
        } else {
            Context._textRender.filltext(context, this._text, this.x
        }
```
ç”±äºwordtextä¼šæŒ‰å•å­—è§£æ å¹¶ä¸”å­˜å‚¨å®½åº¦ æ‰€ä»¥ç™»å½•ç•Œé¢ä¸ä¼šä¸€ç›´è°ƒç”¨
ä½†æ˜¯å­—ç¬¦ä¸²æ•´å¥æ¸²æŸ“  è‹¥éå·¦å¯¹é½ å°±ä¼šè®¡ç®—æ•´ä½“å®½åº¦
``` 
  TextRender.ts
  _fast_filltext(ctx, data, htmlchars
    var isWT = !htmlchars && (data instanceof WordText);
    var splitTex = this.renderPerChar = (!isWT) || TextRender.forceSplitRender || isHtmlChar || (isWT && wt.splitRender);
    if (textAlign != ILaya.Context.ENUM_TEXTALIGN_DEFAULT || !splitTex) 	{
        if (isWT) {  æœ‰ç¼“å­˜
            str = wt._text;
            strWidth = wt.width;
            if (strWidth < 0) {
                strWidth = wt.width = this.charRender.getWidth(this.fontStr, str);
            }
        }
        else {  ä¸€ç›´è¢«è°ƒç”¨çš„åŸå› ï¼ï¼ï¼
            strWidth = str ? this.charRender.getWidth(this.fontStr, str) : 0;
        }
    }
```




### ç»“è®ºï¼š
1. æµè§ˆå™¨ä¸­æµ‹è¯•ç»“æœåªæœ‰width æ²¡æœ‰height
- æ–‡æœ¬çš„é«˜åº¦é€šå¸¸ç”±å­—ä½“çš„å¤§å°ï¼ˆfont sizeï¼‰ã€è¡Œé—´è·ï¼ˆline heightï¼‰





## ç¼“å­˜è§£å†³æ–¹æ¡ˆ

1. Laya.tså’ŒBrowser.ts
```
  å®šä¹‰äº†Browser.measureText å®é™…åªæœ‰ttfloaderä¸€ä¸ªåœ°æ–¹ä½¿ç”¨
  è€Œä¸”é™åˆ¶äº†å•ä¸ªä¸­æ–‡  æ‰€ä»¥è™½ç„¶æœ‰ç¼“å­˜ 
  è§£å†³æ–¹æ¡ˆï¼šä¸é€šç”¨ ä¸”è°ƒç”¨æ—¶æœºå¾ˆå°‘ ä¸åšå¤„ç†ï¼ï¼ï¼
```

2. Text.ts
```
  ä½¿ç”¨äº†browserçš„2dç¯å¢ƒå’Œå­—ä½“ è®¡ç®—å•ä¸ªæµ‹è¯•å­—ä½“ï¼ˆ"æ¸¸"ï¼‰å¤§å° ç”¨äºä¼°ç®—è¡Œå­—ä½“æ•°
  æ³¨æ„ï¼šè¿™é‡Œçš„å­—ä½“è·å– åœ¨ä¸åŒç¯å¢ƒä¸‹è¡¨ç°ä¸åŒ
  let cfont = ILaya.Browser.context.font || this._getContextFont(); //å¿«æ‰‹å¹³å°è·å–åˆ°ç©ºå­—ç¬¦ä¸²
  let font = cfont["font_size"] ?cfont["font_size"] + cfont["font_family"]:cfont;  //qqå¹³å°å¾—åˆ°ä¸€ä¸ªå¯¹è±¡ è€Œéå­—ç¬¦ä¸²
  å¯è€ƒè™‘å°ä¸€ä¸ªå‡½æ•° è·å–contextä¸­å½“å‰fontå­—ç¬¦ä¸²
            
  _parseLines(text: string)
    ILaya.Browser.context.measureText(Text._testWord);
  åˆ†æï¼šè°ƒç”¨é¢‘ç‡å¾ˆé«˜ åˆ‡å­—ç¬¦ä¸²å›ºå®š
  è§£å†³æ–¹æ¡ˆï¼šèµ°è‡ªå·±å†…éƒ¨å‡½æ•° Browser.measureText
  
  _getTextWidth(text: string)
  _updateCurZoom(lines: string[])
  ä¸¤ä¸ªç±»ä¼¼
  åˆ†æï¼š_parseLineæ—¶å†…éƒ¨è°ƒç”¨ è‹¥textçš„æ ¼å¼å˜åŒ– æˆ–é€šè¿‡.text=""çš„æ–¹å¼ä¿®æ”¹
     éƒ½ä¼šè§¦å‘è¿™é‡Œçš„è°ƒç”¨
  è§£å†³æ–¹æ¡ˆï¼šé¢‘ç‡é«˜ éœ€è¦ç¼“å­˜ ä½†æ˜¯å­—ç¬¦ä¸²ä¸å†æ˜¯å•ä¸ªè¡Œå­— æœ¬èº«Browser.measureText
    ä¸å†æ”¯æŒ ä¿®æ”¹å†…éƒ¨å®ç°ï¼š
       æ”¹ä¸ºæ”¯æŒä¸åŒçš„å†…å®¹
       é™åˆ¶ç¼“å­˜æ•°é‡ é˜²æ­¢å†…å­˜è¿‡é‡
```

3. HTMLElement.ts
```
  _getWords(): HTMLChar[]
  åˆ†æï¼šåˆ›å»ºå½“ä¸ªå…ƒç´  ç›´æ¥ä½¿ç”¨äº†Browser.measureText
    ä½†æ˜¯txt.charAt(i)æ–¹å¼å¾—åˆ°çš„å•ä¸ªè‹±æ–‡ å•ä¸ªä¸­æ–‡ï¼Ÿ
  è§£å†³æ–¹æ¡ˆï¼š
    æ‰©å±•å‡½æ•° æ”¯æŒéä¸­æ–‡ç¼“å­˜
```

4. Layout.ts
å·²æ³¨é‡ŠåºŸå¼ƒäº†

5. TTFLoader.ts
```
  _testString: string = "LayaTTFFont"
  _checkComplete(): void {
    if (ILaya.Browser.measureText(TTFLoader._testString, 
  åˆ†æï¼šç±»ä¼¼Text._parseLines éƒ½ç”¨æµ‹è¯•å­—ç¬¦ä¸²æ¥è®¡ç®— 
    ä¸åŒçš„æ˜¯ è¿™é‡Œç”¨äº†è‹±æ–‡å­—ç¬¦ä¸² é‚£è¾¹ç”¨äº†å•ä¸ªæ±‰å­—
  è§£å†³æ–¹æ¡ˆï¼š
    æ‰©å±•å‡½æ•° æ”¯æŒéä¸­æ–‡ç¼“å­˜
```

6. Context.ts
æ²¡å®ç°  ä¸åšå¤„ç†

7. Browser.ts
```
  é‡æ–°å®ç°measureText ä¸Šé¢çš„æ‰€æœ‰åŠŸèƒ½éƒ½è°ƒç”¨äº†è¿™é‡Œ
  è§£å†³æ–¹æ¡ˆï¼š
  æœ‰ä¸­æ–‡çš„å­—ç¬¦ä¸² å¿…ç¼“å­˜
  å…¶ä»–æƒ…å†µ ç¼“å­˜+é™åˆ¶æ•°é‡
  æ˜¯å¦è€ƒè™‘ ç»Ÿä¸€ä¸ºä¸€ä¸ªï¼Ÿ
```

8. CharRender_Canvas.ts
```
  getWidth(font: string, str: string)
  åˆ†æï¼šç‹¬ç«‹çš„canvaså’Œ2d å’Œbrowserä¸åŒ
    è®¡ç®—å®½åº¦ä¼šå¸¦å…¥å­—ä½“ 

  getCharBmp(
  getCharCanvas(
    var ctx: any = this.ctx;
    if (ctx.font != font) {// ctx._lastFont != font) {
        ctx.font = font;
        ctx._lastFont = font;
    }
    cri.width = ctx.measureText(char).width;
  åˆ†æï¼šæ•´ç†é€»è¾‘åŒä¸Š ä½†æ˜¯å­—ä½“åˆ¤æ–­ä¸åŒ ä¸ç”¨_lastFontåˆ¤æ–­
  è§£å†³æ–¹æ¡ˆï¼š
    ç»Ÿä¸€ä¸ºä¸€ä¸ªå‡½æ•° ä¿®æ”¹getWidthçš„å®ç°æ–¹å¼ 
    å†…éƒ¨æ–°å¢å‡½æ•°measureText ç”¨ç¼“å­˜çš„æ–¹å¼å®ç° ç±»ä¼¼browser
```

9. CharRender_Native.ts
```
  è§£å†³æ–¹æ¡ˆï¼šåŒä¸Š 
    æ‰€ä»¥é¢å¤–å°è£…ä¸€ä¸ªå‡½æ•° æ¯”å¦‚Context.measureText(ctx, str, font)
    å°†ctxä¼ å…¥ æ¥é€šç”¨native canvas browser
```



## changtextä¼˜åŒ–
é»˜è®¤çš„æ–¹å¼ ä¼šä¿®æ”¹textä¸­ä¸Šæ¬¡åˆ›å»ºçš„FillTextCmdå¯¹è±¡  
å¯¼è‡´å†…éƒ¨çš„wordtextè¢«æ¸…é™¤ æ ¹æ®ä¸Šé¢çš„é€»è¾‘ æ¸²æŸ“æ—¶ç”±äºæ²¡äº†wtçš„ä¿¡æ¯ å°†å®æ—¶è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦  
ä¼˜åŒ–ï¼š  
  è‹¥æ˜¯å•è¡Œ åˆ™ç»§ç»­ä½¿ç”¨wtæ¨¡å¼ å¹¶ä¿®æ”¹å®ƒå†…éƒ¨çš„å­—ç¬¦ä¸² è¿™æ ·æ¸²æŸ“æ—¶ ç¬¬äºŒæ¬¡å å°†ç»§ç»­ç”¨é¢„å­˜çš„ä¿¡æ¯  
  è¿™ä¹Ÿæ˜¯ä¸ºä½•è¿™æ ·ä¼˜åŒ–å å±±æµ·ä¸»ç•Œé¢ä¸ä¼šç»§ç»­ä¸€ç›´è°ƒç”¨measuerText
```
  Label.ts
  changeText(text: string): void {
      this._tf.changeText(text);
  }

  Text.ts
  changeText(text: string): void {
     let word: string|WordText = null;
      if (this._changeTextUseWT && this._words && this._words.length == 1) {
          word = this._words[0];
          word.setText(this._text);  //WordTextæ•´æ–‡å­—ä¸²æ¸²æŸ“ æ€§èƒ½æ›´å¥½
      } else {
          word = this._text;
      }

      if (this._graphics && this._graphics.replaceText(word)) {
          //repaint();
      } else {
          this.typeset();
      }

  FillTextCmd.ts
  set text(value: string | WordText) {
        //TODO é—®é¢˜ã€‚ æ€ä¹ˆé€šçŸ¥native
        this._text = value;
        this._textIsWorldText = value instanceof WordText;
        this._textIsWorldText && ((<WordText>this._text)).cleanCache();
    }
```
- å°ç»“ï¼š
1. é»˜è®¤æ‰€æœ‰labelçš„changeText æ”¯æŒä¿®æ”¹æ–‡å­— é¢œè‰² å¤§å°ï¼›ä¸æ”¯æŒä¿®æ”¹æ’ç‰ˆï¼šæ¢è¡Œ å¯¹é½
2. é»˜è®¤å¼€å¯_changeTextUseWTå ä¿®æ”¹åçš„æ–‡å­—å°†ä»¥wtæ•´ä¸ªå­—ç¬¦ä¸²æ–¹å¼æ¸²æŸ“ ä¸”ç”±äºæœ‰å­—ç¬¦é›†ç¼“å­˜ ç®—å®½åº¦å¾ˆå¿«
3. è‹¥å€’è®¡æ—¶ç±»labelæˆ–è€…å±æ€§ç»å¸¸å˜æ¢çš„label éœ€è¦é¢å¤–ä½¿ç”¨lblTime.useAsNumber = true;  
   å®ƒä¼šå¼ºåˆ¶å°†å­—ç¬¦ç”¨æˆªæ–­æ–¹å¼æ¸²æŸ“ å¯èŠ‚çœå¾ˆå¤šå­—ä½“åˆå›¾  
   æ³¨æ„ï¼š
   a å¿…é¡»å¼€å¯å°ºå¯¸ç¼“å­˜ï¼ï¼ï¼ å¦åˆ™getWithä¼šæ²¡å¸§è°ƒç”¨ è‹¥æ˜¯1ç§’çš„å®šæ—¶å™¨ åˆ™é‡å¤è®¡ç®—å‡ åæ¬¡ï¼ˆæ»¡å¸§60æ¬¡ï¼‰
   b å¿…é¡»å’ŒchangeTextä¸€èµ·ä½¿ç”¨ è‹¥è¿˜æ˜¯ç”¨label.text = "00:01" åˆ™ä¼šèµ°æ•´ä¸ªå­—ç¬¦ä¸²çš„wtæ–¹å¼
     è™½ç„¶æ²¡æœ‰getwidthé—®é¢˜ ä½†å¤šäº†çº¹ç†å¤šä»½é—®é¢˜-ä¸”æ›´æ–°é¢‘ç¹ å½±å“æ€§èƒ½
```
   _fast_filltext(ctx, data
    åˆ‡å‰²å­—ç¬¦ä¸²ï¼šéwt æˆ–æ€»å¼€å…³forceSplitRender æˆ– html æˆ– wtè‡ªå·±ç‰¹æœ‰æ ‡è®°splitRender
    æ‰€ä»¥å­˜æ–‡å­—æ¸²æŸ“æ–¹å¼ è‚¯å®šä¼šè¢«åˆ‡å‰²
    var splitTex = this.renderPerChar = (!isWT) || TextRender.forceSplitRender || isHtmlChar || (isWT && wt.splitRender);
    if(textAlign != ILaya.Context.ENUM_TEXTALIGN_DEFAULT || !splitTex) {
            if (isWT) {
                str = wt._text;
                strWidth = wt.width;  å¦‚æœæ˜¯wt ä¼šç”¨å­˜å‚¨çš„å€¼ æ— éœ€æ²¡å¸§è®¡ç®—
                if (strWidth < 0) {
                    strWidth = wt.width = this.charRender.getWidth(this.fontStr, str);	// å­—ç¬¦ä¸²é•¿åº¦æ˜¯åŸå§‹çš„ã€‚
                }
            } else {
                æ¯”è¾ƒæ¶å¿ƒçš„åœ°æ–¹ æ¯å¸§éƒ½ä¼šè®¡ç®—  è€Œä¸”æ˜¯è°ƒç”¨åº•å±‚çš„æ–¹å¼ æ€§èƒ½å·® å†…å­˜çˆ†å¢åŠ  
                å®¹æ˜“å¡å’Œé—ªé€€
                strWidth = str ? this.charRender.getWidth(this.fontStr, str) : 0;
            }
        }
```
4. å¼€å¯useAsNumberå¸¦æ¥çš„æ–°é—®é¢˜ï¼šå®šæ—¶å™¨ç±» ä¼šå¯¼è‡´æ²¡å¸§çš„getwidth
   ç”±äºæ²¡æœ‰wtçš„å•ä¸ªå­—ä½“ä¿¡æ¯ å–æ•´ä¸ªå­—ç¬¦ä¸²é•¿åº¦-å†…å®¹åœ¨å˜åŒ– å°±éœ€è¦èµ°åº•å±‚ æ€ä¹ˆä¼˜åŒ–ï¼Ÿ



## å­—ä½“ç¼©æ”¾åŠ¨ç”»å¸¦æ¥çš„é—®é¢˜
layaå†…éƒ¨æœ‰ä¸ªå¼€å…³ æ§åˆ¶textæ§ä»¶ç¼©æ”¾å å­—ä½“çš„æ¸…æ™°åº¦ å°†ç”¨è®¾å¤‡åˆ†è¾¨ç‡è€Œéå›ºå®šçš„è®¾è®¡åˆ†è¾¨ç‡  
```
  Laya.TextRender.scaleFontWithCtx = true;  

  æ‰“å°logå’Œè¾“å‡ºç¼“å­˜å›¾ç‰‡
  Laya.TextRender.showLog = true;
  Laya.TextRender.textRenderInst.printDbgInfo()
  Laya.Context["_textRender"].saveAtlasPng();
  sg.Logger.openLog = true

  ç¼ºç‚¹ï¼šå½“æ‰“å¼€ç•Œé¢æ—¶ æ‰€æœ‰ç¼©æ”¾åŠ¨ç”» åˆ™ä¼šäº§ç”Ÿå¾ˆå¤šä»½æ–‡å­—ç›¸åŒ å¤§å°ä¸åŒçš„çº¹ç†
    å¯¼è‡´å­—ä½“ç¼“å­˜å¾ˆå®¹æ˜“æº¢å‡º 
    å¦å¤–æ‰“å¼€æ—¶æ€§èƒ½é—®é¢˜ åŠ¨ç”»ä¹Ÿå˜å¡
```



## é—æ¼é—®é¢˜

### 1. useAsNumberå å®šæ—¶å™¨ç±»å¤§é‡getWidthè°ƒç”¨é—®é¢˜
- æ€ä¹ˆè§£å†³å®šæ—¶å™¨ç±»å­—ç¬¦ä¸²getWidthä¸­å†…éƒ¨ä¸€ç›´measureTexté—®é¢˜ï¼Ÿ
- ç”±äºå­—ç¬¦ä¸²å·²ç»å˜åŒ– ç¼“å­˜ä¸­æ˜¯æ— æ³•åŒºåˆ†çš„ ä¼°è®¡éœ€è¦åœ¨textä¸­åŠ¨è„‘ç­‹

- æ–¹æ¡ˆ1ï¼šåç»­åˆ‡å‰²å­—ç¬¦ä¸²è·å–çº¹ç†ä¿¡æ¯æ—¶ è‹¥éwtæƒ…å†µ ä¿æŒå•ä¸ªæ–‡å­—çš„å®½åº¦
```
  TextRender.ts
  _fast_filltext(ctx: Context, data: string | WordText|null
    å¯¹é½æ–¹å¼ æˆ– æ•´å¥æ¸²æŸ“ éœ€è¦è®¡ç®—ä¸€æ¬¡æ•´ä½“çš„å®½åº¦ ç”¨äºè°ƒæ•´xå€¼
    if(textAlign != ILaya.Context.ENUM_TEXTALIGN_DEFAULT || !splitTex) {
      if (isWT) {
        strWidth = wt.width;
      else {
        strWidth = str ? this.charRender.getWidth(this.fontStr, str) : 0;
      }

    wtä¼šç¼“å­˜å•ä¸ªå­—ä½“æˆ–æ•´å¥çš„ä¿¡æ¯
    var sameTexData: any[] = isWT ? wt.pageChars : [];
    if (!sameTexData || sameTexData.length < 1) {
      if (splitTex) {
        while (true) {
          curstr = this.getNextChar(str);
          ri = this.getCharRenderInfo(curstr, font, color, strokeColor, lineWidth, false);
          var o1 = { texgen: ((<TextTexture>ri.tex)).genID, tex: ri.tex, words: [] };
          sameTexData[ri.tex.id] = o1;
          o1.words.push({ ri: ri, x: stx, y: sty, w: ri.bmpWidth / this.fontScaleX, h: ri.bmpHeight / this.fontScaleY });  å­˜å‚¨å•ä¸ªå­—çš„ä½ç½® ç¼©æ”¾ ç”¨o1çš„çº¹ç†
          ä¸ºä½•æ˜¯words[]ï¼Ÿ ç”±äºä½¿ç”¨çš„tex.genidä½œä¸ºkeyå­˜å‚¨ åˆ™æ‰€æœ‰ç›¸åŒçº¹ç†å…±ç”¨ä¸€ä¸ªo1å¯¹è±¡
          wordså†…å­˜æ”¾çš„æ˜¯å¤šä¸ªæ–‡å­— å…±ç”¨åŒä¸€ä¸ªçº¹ç†  é‚£uvåæ ‡æ€ä¹ˆæ§åˆ¶çš„ï¼Ÿ ä¸ºä½•ä¸åœ¨wordså†…ï¼Ÿ
    æ‹¿è®¡ç®—çš„çº¹ç†æ•°æ® æ¸²æŸ“
    this._drawResortedWords(ctx, x, y, sameTexData);
    å¦‚æœéwtå¯¹è±¡ sameTexDataå°†è¢«å›æ”¶

    éœ€è¦è€ƒè™‘emoji æ§åˆ¶å­—ç¬¦ å¤šç§è¯­è¨€
    ç”±äºè®¡ç®—ä¹Ÿæ¯”è¾ƒå¤æ‚ åˆ‡éœ€è¦åŠ¨æ€äº§ç”Ÿå­å­—ç¬¦ä¸² å¯ä»¥è€ƒè™‘ç¼“å­˜ï¼Ÿ å› ä¸ºæ¯å¸§æ¸²æŸ“éƒ½åœ¨åˆ‡å‰²
    getNextChar(str: string): string |null {

    è§£å†³ï¼š
    è‹¥split ä¸”éwt åˆ™é€šè¿‡getNextCharåˆ‡å‰²çš„å­å­—ç¬¦çš„å®½åº¦ å­˜å‚¨èµ·æ¥
    å¯¹å­—ç¬¦ä¸²åˆ‡å‰²ä¹Ÿåšç¼“å­˜
    ---
    ç»“åˆä¸¤è€… ç»Ÿä¸€å¤„ç† å¯é¢å¤–å®šä¹‰ç±» æˆ–æ”¾åˆ°TextRenderä¸­
    private splitStrCache:Map<string, string[]>;
    private splitStrWithMap:Map<string, Map<string, number>>;  //<font, <str, width>>
    static max_split_cache_size = 500;  æ¸…ç†ä¸¤ä¸ªmap
    
    getStringSplit(str): string[];
    saveStringSplit(str, splitStr: string[]);
    getStringWidthFromSplit(font, str): number;  å¤±è´¥ è¿”å›0
    setStringWidthToSplit(font:string, str:string, w:number);

   --
   åŠŸèƒ½å®ç° æ„Ÿè§‰ç”¨å¤„ä¸å¤§ è€Œä¸”å˜å¤æ‚äº†
   å­—ç¬¦ä¸²ä¸€ç›´è¿˜åœ¨å˜åŒ– æ‰€ä»¥ä¼šæ¯ç§’è§¦å‘ä¸€æ¬¡é‡æ–°è®¡ç®— 
   å®é™…å°±ä¼˜åŒ–äº†1ç§’å†…çš„å­—ç¬¦ä¸²åˆ‡å‰²å’Œgetwidth(æŒ‰å•ä¸ªå­—è®¡ç®—å®½åº¦)-è‹¥å¼€å¯äº†å°ºå¯¸ç¼“å­˜å°±æ„ä¹‰ä¸å¤§äº†
```


1. å­—ç¬¦å¼€å¯é«˜æ¸…åå’Œuiç¼©æ”¾åŠ¨ç”»å†²çªé—®é¢˜ï¼Ÿ
Laya.TextRender.scaleFontWithCtx = true  
æ€ä¹ˆé¿å…ä¸­é—´å¤šä½™çš„è¿‡åº¦å­—ä½“ ç›´æ¥ç”¨æœ€æ¸…æ™°çš„å­—ä½“åšåå‘ç¼©æ”¾ï¼Ÿ








